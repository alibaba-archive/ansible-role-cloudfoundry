---

- name: create ecs instance and build network environment
  hosts: localhost
  tasks:
    - shell: terraform init
      args:
        chdir: ./server

    - expect:
        command: terraform destroy -var 'alicloud_access_key={{ alicloud_access_key }}' -var 'alicloud_secret_key={{ alicloud_secret_key }}' -var 'alicloud_region={{ alicloud_region }}'
        responses:
          'Enter a value:' : 'yes'
        chdir: ./server
      when: delete

    - shell: terraform apply -var 'alicloud_access_key={{ alicloud_access_key }}' -var 'alicloud_secret_key={{ alicloud_secret_key }}' -var 'alicloud_region="{{ alicloud_region }}"'
      args:
        chdir: ./server
      when: not delete

- name: Wait 300 seconds for port 22 to become open on the host, don't start checking for 5 seconds
  hosts: CloudFoundaryServer
  remote_user: root
  tasks:
    - wait_for:
        port: 22
        delay: 5

- name: deploy cf
  hosts: CloudFoundaryServer
  remote_user: root
  roles:
    - bosh-cli
    - spiff-deploy
    - bosh-deploy
    - cf-deploy
    - app-deploy
